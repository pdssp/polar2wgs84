# Workflow to avoid duplicate pipelines for branches and merge requests:
# https://docs.gitlab.com/ee/ci/yaml/workflow.html#switch-between-branch-pipelines-and-merge-request-pipelines
workflow:
  rules:
    # Run pipeline for merge request events
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

    # Skip branch pipeline if there is an open merge request
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never

    # Run pipeline for branch commits
    - if: $CI_COMMIT_BRANCH

    # Override variables when tags are used (production)
    - if: $CI_COMMIT_TAG
      variables:
        ARTIFACTORY_USER: "${PDSSP_PROD_USERNAME}"
        ARTIFACTORY_TOKEN: "${PDSSP_PROD_TOKEN}"
        ARTIFACTORY_REPO: "pdssp-pip-prod-local"

    # Fallback
    - when: always

# Define global CI/CD variables for the pipeline
variables:
  CI: "true"
  # The module name must match the one defined in pyproject.toml:
  PROJET_SLUG: "polar2wgs84"
  # JFROG_CLI_HOME_DIR: [Default: ~/.jfrog]. Sets the configuration file path for JFrog CLI.
  JFROG_CLI_HOME_DIR: ".jfrog"
  # JFROG_CLI_TEMP_DIR: [Default: /tmp]. Sets the path for JFrog CLI temporary files.
  JFROG_CLI_TEMP_DIR: ".jfrog_tmp"
  # OS version of the machine (on GitLab-CI, it will always be amd64)
  JFROG_OS: "jfrog-cli-linux-amd64"

  # Artifactory credentials and repository
  ARTIFACTORY_USER: "${PDSSP_DEV_USERNAME}" # or ${PDSSP_PROD_USERNAME}
  ARTIFACTORY_TOKEN: "${PDSSP_DEV_TOKEN}" # or ${PDSSP_PROD_TOKEN}
  ARTIFACTORY_REPO: "pdssp-pip-dev-local" # or pdssp-pip-prod-local

  # Variables for JFrog applications, Artifactory, artifacts, etc.
  #---------------------------
  # Pair of variables to build the build info path in Artifactory. This pair must be unique.
  JFROG_CLI_BUILD_NAME: "${CI_PROJECT_PATH}_${CI_COMMIT_REF_SLUG}_gitlab-ci"
  JFROG_CLI_BUILD_NUMBER: "${CI_PIPELINE_ID}"

  # URL to fetch the Docker image for running the SAST analysis
  CI_TEMPLATE_REGISTRY_HOST: "${UL_ARTIFACTORY_HOST}/publicremotes-docker"

  # Variables for application development
  #---------------------------
  # URL for the private PyPI index, using credentials for authentication
  PIP_INDEX_URL : "https://${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN}@${UL_ARTIFACTORY_HOST}/artifactory/api/pypi/pypi/simple"
  # Variable to move the pip cache directory to the workspace
  PIP_CACHE_DIR: "${WORKSPACE}/.pip-cache/"
  # Token for authenticating with SonarQube
  SONAR_TOKEN : ${PDSSP_SONAR_TOKEN}
  # Project Version
  PROJECT_VERSION : "0.0.0"


# Include the SonarQube component for code quality analysis
# This component is maintained in a separate repository and provides reusable SonarQube integration
# see https://gitlab.cnes.fr/usinelogicielle/public/gitlab-ci-components/sonarqube-component
include:
  - component: $CI_SERVER_FQDN/usinelogicielle/public/gitlab-ci-components/sonarqube-component/sonarqube@1.3.0
    inputs:
      # Admin user for SonarQube, used for configuration and permissions
      sq_users_admin: jean-christophe.malapert@cnes.fr
      sq_users_reader: ${TEAM_EMAIL}
      custom_args_sonar_scanner: -Dsonar.gitlab.url=${CI_PROJECT_URL} -Dsonar.links.ci=${CI_PROJECT_URL}/pipelines -Dsonar.links.issue=${CI_PROJECT_URL}/-/issues -Dsonar.links.scm=${CI_PROJECT_URL} -Dsonar.projectBaseDir=${CI_PROJECT_DIR} -Dsonar.projectVersion=${PROJECT_VERSION}

# Default configuration for all jobs in this pipeline
default:
  tags:
    - Usine_Logicielle # Specifies the GitLab Runner tag to use for job execution

# Base job template for all Python-related jobs
.python-job:
  # Use a Docker image from the internal registry for Python jobs
  image: ${CI_TEMPLATE_REGISTRY_HOST}/${TAG_DOCKER_IMAGE_PYTHON}
  before_script:
    # Installation de Graphviz pour la gÃ©nÃ©ration de graphiques
    - apt-get update && apt-get install -y graphviz
    # Download the JFrog CLI for artifact management
    - curl -sS -u ${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN} -O "https://${UL_ARTIFACTORY_HOST}/artifactory/jfrog-cli-go-remote/v2/2.78.1/jfrog-cli-linux-amd64/jfrog"
    # Grant execute permissions to the JFrog CLI binary
    - chmod 755 jfrog
    # Generate a unique UUID for this job, useful for tracking and logging
    - export UUID=$(cat /proc/sys/kernel/random/uuid)
    # Store the UUID in a file to pass it between jobs if needed
    - touch uuid.txt
    - echo ${UUID} > uuid.txt
    # Configuration du serveur JFrog pour tous les jobs
    - ./jfrog config add ${UUID}
      --url=https://${UL_ARTIFACTORY_HOST}/
      --access-token=${ARTIFACTORY_TOKEN}
    # Upgrade pip to the latest version to avoid compatibility issues
    - pip install --upgrade pip
    # Install required Python packages for the project
    - pip install cookiecutter uv
    # Environment variables for SSL support
    - export REQUESTS_CA_BUNDLE=${CNES_CERTIFICATE}
    - export SSL_CERT_FILE=${CNES_CERTIFICATE}

# Define the stages of the pipeline and their execution order
stages:
  - test      # Stage for running tests
  - sonarqube # Stage for SonarQube analysis
  - doc       # Stage to build the documentation
  - package   # Stage to build package
  - deploy    # Stage to deploy package
  - sync      # Stage to sync to github

# Job to build and publish documentation as GitLab Pages
pages:
  image: ${CI_TEMPLATE_REGISTRY_HOST}/${TAG_DOCKER_IMAGE_PYTHON}
  stage: doc
  retry: 2
  extends: .python-job
  script:
    - make prepare-dev
    - source .venv/bin/activate
    - make install-dev
    - make doc
    - mkdir public
    - mv site/* public

  artifacts:
    paths:
      - public

# Job to run tests and generate coverage reports
test:
  stage: test
  retry: 2
  extends: .python-job
  artifacts:
    expose_as: coverage report
    when: always
    paths:
      - coverage.xml
      - report.xml
    reports:
      junit: report.xml
  script:
    - make prepare-dev
    - source .venv/bin/activate
    - make install-dev
    - make coverage
    - make coverage_xml
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "ci" || $CI_COMMIT_TAG != null

# Job to prepare and set the project version
prepare_version:
  # Inherit the base configuration from the .python-job template
  extends: .python-job
  # Specify that this job runs in the 'test' stage
  stage: test
  retry: 2
  script:
    # Get Project version
    - UV_VERSION=$(uv version --short)
    # Fill up the variable
    - PROJECT_VERSION="${UV_VERSION}"
    - echo "PROJECT_VERSION=$PROJECT_VERSION" >> version.env
  artifacts:
    reports:
      dotenv: version.env

# Job to build the package
package:
    stage: package
    retry: 2
    extends: .python-job
    script:
      - make prepare-dev
      - source .venv/bin/activate
      - make release
    artifacts:
        untracked: true
        expire_in: 1 day

# Job to publish the package to Artifactory
publish-artifactory:
  stage: deploy
  retry: 2
  extends: .python-job
  needs:
    - package

  script:
    # Obtention de UUID pour rÃ©cupÃ©rer la config de jfrog cli
    - export UUID=`cat uuid.txt`

    # ðŸŽ¯ Upload du package (wheel + tar.gz) vers Artifactory
    # Le repo cible est "${ARTIFACTORY_REPO}"
    - ./jfrog rt u "dist/*" "${ARTIFACTORY_REPO}" --module=${PROJET_SLUG} --build-name=${PROJET_SLUG} --build-number=${CI_PIPELINE_IID}

    # ðŸ“¦ Publication du build-info dans Artifactory
    - ./jfrog rt bp --server-id=${UUID} ${PROJET_SLUG} ${CI_PIPELINE_IID} --build-url="${CI_PIPELINE_URL}"

sync_to_github:
  stage: sync
  retry: 2
  image: ${CI_TEMPLATE_REGISTRY_HOST}/${TAG_DOCKER_IMAGE_PYTHON}
  script:
    - git config --global user.email "jean-christophe.malapert@cnes.fr"
    - git config --global user.name "Jean-Christophe Malapert"
    - git config --global http.sslCAInfo "${CNES_CERTIFICATE}"
    - git remote add github https://${GITHUB_TOKEN}@github.com/pdssp/polar2wgs84
    - git fetch github
    - git push github "HEAD:refs/heads/main"
  only:
    - main  # ExÃ©cute uniquement pour les modifications sur la branche "main"
